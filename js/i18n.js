(function () {
  'use strict';

  const STORAGE_KEY = 'mathsLenaLanguage';
  const DEFAULT_LANGUAGE = 'fr';
  const LANGUAGE_LABELS = {
    fr: 'Français',
    nl: 'Nederlands',
    en: 'English',
    es: 'Español'
  };
  const LANGUAGE_LOCALES = {
    fr: 'fr-FR',
    nl: 'nl-NL',
    en: 'en-GB',
    es: 'es-ES'
  };
  let currentLanguage = null;

  const STRINGS = {
    fr: {
      languageLabel: 'Langue',
      languageSelectAria: 'Choisir la langue',
      confirmLogout: 'Veux-tu vraiment te déconnecter ?',
      navHome: 'Accueil',
      navShop: 'Boutique',
      navAchievements: 'Succès',
      navLibrary: 'Bibliothèque',
      navBack: 'Retour',
      navLogout: 'Sortir',
      audioOn: 'Son actif',
      audioOff: 'Son coupé',
      notifications: 'Notifications',
      levelLabel: 'Niveau',
      fallbackName: 'Ami Magique',
      loginBadge: '✨ Choisis ton avatar ✨',
      loginTitle: 'Bienvenue dans ton aventure magique',
      loginSteps: 'Sélectionne un avatar, choisis ta couleur préférée et écris ton prénom.',
      loginPlayButton: 'Jouer',
      loginParentAccess: 'Accès parents',
      loginParentHold: 'Maintiens 2 secondes',
      calmModeLabel: 'Mode Calme',
      calmModeDescription: 'Moins d\'animations et de sons.',
      calmModeOn: 'Calme activé',
      calmModeOff: 'Calme désactivé',
      selectedAvatarLabel: 'Avatar choisi',
      selectedAvatarPlaceholder: 'Choisis ton avatar',
      selectedNameLabel: 'Ton prénom',
      selectedNamePlaceholder: 'Écris ton prénom',
      avatarSectionTitle: 'Avatars délicieux',
      avatarListLabel: 'Choisis ton avatar préféré',
      namePlaceholder: 'Écris ton prénom ici...',
      nameAria: 'Écris ton prénom',
      colorSectionTitle: 'Choisis ta couleur préférée',
      colorListLabel: 'Choisis ta couleur préférée',
      avatarUnicorn: 'Licorne',
      avatarFox: 'Renard',
      avatarPanda: 'Panda',
      avatarOwl: 'Hibou',
      avatarStrawberry: 'Fraise',
      avatarApple: 'Pomme',
      avatarBanana: 'Banane',
      avatarPineapple: 'Ananas',
      colorRoseLabel: 'Rose pastel',
      colorApricotLabel: 'Abricot doux',
      colorLemonLabel: 'Citron léger',
      colorMintLabel: 'Menthe fraîche',
      colorOceanLabel: 'Océan clair',
      colorSkyLabel: 'Ciel calme',
      colorLavenderLabel: 'Lavande',
      colorRaspberryLabel: 'Framboise légère',
      colorWhiteLabel: 'Blanc magique',
      colorRoseTooltip: '🌸 Rose pastel',
      colorApricotTooltip: '🍑 Abricot doux',
      colorLemonTooltip: '🍋 Citron léger',
      colorMintTooltip: '🌿 Menthe fraîche',
      colorOceanTooltip: '🌊 Océan clair',
      colorSkyTooltip: '☁️ Ciel calme',
      colorLavenderTooltip: '💜 Lavande',
      colorRaspberryTooltip: '🍓 Framboise légère',
      colorWhiteTooltip: '✨ Blanc magique',
      ownedAvatarUse: 'Utiliser',
      ownedBackgroundSet: 'Définir',
      avatarAlt: 'Avatar',
      backgroundAlt: 'Fond',
      loginButton: 'Entrer dans le monde de Léna',
      loginError: 'Écris ton prénom et choisis un avatar ✨',
      gameBack: 'Retour',
      gameWorld: 'Monde Magique',
      gameReady: 'Prêt à jouer',
      gameHint: 'Indice',
      gameStart: 'Démarrer',
      gameValidate: 'Valider',
      gameNext: 'Suite',
      gameCalm: 'Calme',
      gameAnswerPlaceholder: 'Ta réponse',
      menuPrompt: 'Sélectionne un sujet pour commencer.',
      menuChooseLevel: 'Choisis un niveau pour {{topic}}',
      menuBackToTopics: 'Retour aux sujets',
      menuBackToMenu: 'Retour au menu principal',
      menuBackToLevels: 'Retour aux niveaux',
      menuBackToStories: 'Retour aux contes',
      menuBackToMemoryLevels: 'Retour aux niveaux de mémoire',
      menuNoQuestions: 'Aucune question disponible pour ce niveau pour le moment.',
      menuReviewDone: 'Tu as fini la révision. Bravo !',
      menuNoLevels: 'Aucun niveau disponible pour le moment.',
      reviewFinish: 'Terminer la révision',
      sortingDragHint: 'Glisse-les et lâche-les dans le bon panier.',
      comingSoonTitle: 'Bientôt',
      comingSoonMessage: 'Ce jeu magique sera bientôt disponible !',
      storyLibraryTitle: 'Bibliothèque des Contes Magiques',
      storyNoResults: 'Aucun conte ne correspond à ta recherche.',
      storyPrevCollection: 'Collection Précédente',
      storyNextCollection: 'Collection Suivante',
      storyReadToMe: 'Lis-moi l\'histoire',
      storyReadMyself: 'Je lis toute seule',
      storyListenAria: 'Lire le conte en voix haute',
      shopBackToMenu: 'Retour au menu',
      starsLabel: 'Étoiles',
      coinsLabel: 'Pièces',
      shopFilterAll: 'Tout',
      filterAll: 'Tous',
      shopFilterStickers: 'Stickers',
      shopFilterAvatars: 'Avatars',
      shopFilterBackground: 'Fonds',
      shopFilterSound: 'Sons',
      shopFilterOwned: 'Mes trésors',
      shopHeroTitle: '✨ Boutique Magique ✨',
      shopHeroSubtitle: 'Collectionne des trésors scintillants et personnalise ton aventure !',
      shopRareTitle: '🌟 Marché Rare 🌟',
      shopMainTitle: '🛍️ Boutique Principale 🛍️',
      shopMainSubtitle: 'Parcourir tous les accessoires magiques disponibles aujourd\'hui.',
      shopTreasuresTitle: '🎁 Mes Trésors 🎁',
      shopTreasuresSubtitle: 'Retrouve ici tous les objets que tu possèdes déjà.',
      shopLoadErrorTitle: 'Erreur de chargement de la boutique !',
      shopLoadErrorBody: 'Veuillez vérifier la console pour les erreurs et rafraîchir la page.',
      baseTenBuildTitle: 'Construis le nombre',
      baseTenBuildGoal: 'Nombre cible',
      baseTenBuildFree: 'Mode libre',
      baseTenBuildBreak: 'Rompre une dizaine',
      baseTenBuildGroup: 'Regrouper 10 unités',
      baseTenBuildHint: 'Glisse les blocs pour construire le nombre.',
      baseTenBuildFeedback: 'Super ! Il existe plusieurs façons !',
      baseTenBuildEncourage: 'Super essai ! Ajustons encore un peu.',
      baseTenBlockTen: 'Bloc de dix',
      baseTenBlockOne: 'Bloc d\'une unité',
      baseTenBankLabel: 'Banque de blocs',
      baseTenBuildZone: 'Zone de construction',
      baseTenSubtractTitle: 'Soustraire, c\'est transformer',
      baseTenSubtractGoal: 'On transforme pour retirer',
      baseTenSubtractStepTransform: 'Transformons une dizaine.',
      baseTenSubtractStepEasier: 'Maintenant, c\'est plus facile à retirer.',
      baseTenSubtractStepRemove: 'Retire les blocs demandés.',
      baseTenSubtractFeedback: 'Bien joué ! Tu as transformé et retiré.',
      baseTenSubtractEncourage: 'Doucement, on y arrive ensemble.',
      baseTenSubtractTransformBtn: 'Transformer une dizaine',
      baseTenSubtractRemoveBtn: 'Retirer maintenant',
      baseTenSubtractNextBtn: 'Suite',
      calmToggleAria: 'Activer ou désactiver le mode calme',
      parentResetLabel: 'Réinitialiser les données',
      parentResetConfirm: 'Es-tu un parent ? Tape \"OK\" pour confirmer.',
      parentResetSuccess: 'Les données ont été réinitialisées.',
      parentResetCancel: 'Réinitialisation annulée.',
      parentPanelTitle: 'Espace parents',
      parentPanelClose: 'Fermer',
      shopTitle: 'Boutique de récompenses',
      shopClose: 'Fermer la boutique',
      shopSubtitle: 'Échange tes pièces contre des cadeaux magiques ✨',
      shopAvailable: 'Articles disponibles',
      shopInventory: 'Mes trésors',
      sectionMathTitle: 'Mathématiques',
      sectionNewGamesTitle: 'Nouveaux Jeux',
      sectionLogicTitle: 'Logique & Raisonnement',
      sectionWordsTitle: 'Mots & Lecture',
      sectionCreativeTitle: 'Créatif & Monde',
      sectionEmotionsTitle: 'Cœur & Émotions',
      itemAdditions: 'Additions',
      itemSubtractions: 'Soustractions',
      itemMultiplications: 'Multiplications',
      itemDivisions: 'Divisions',
      itemMathSprint: 'Maths Sprint',
      itemAbacus: 'Abaque Magique',
      itemNumberHouses: 'Maisons des Nombres',
      itemTime: 'Temps & Horloges',
      itemMeasures: 'Mesures Magiques',
      itemFractions: 'Fractions Fantastiques',
      itemLabyrinth: 'Labyrinthe Logique',
      itemSequences: 'Jeu des Séquences',
      itemSorting: 'Tri & Classement',
      itemMemory: 'Mémoire Magique',
      itemSudoku: 'Sudoku Junior',
      itemSymmetry: 'Symétrie Magique',
      itemComparisonCards: 'Cartes Comparatives',
      itemPathNetworks: 'Réseaux de Chemins',
      itemLogicgrams: 'Logigrammes (Si... Alors...) ',
      itemRiddles: 'Jeu d\'Énigmes',
      itemRepartis: 'Répartis & Multiplie',
      itemReading: 'Lecture Magique',
      itemBigAdventure: 'La Grande Aventure des Mots',
      itemToolWords: 'Mots-Outils',
      itemVowels: 'Jeu des Voyelles',
      itemWitches: 'Les Sorcières - Jeu de Mémoire Magique',
      itemDictation: 'Dictée Magique',
      itemColors: 'Les Couleurs / Atelier d\'Art',
      itemPuzzle: 'Puzzle Magique',
      itemWorldMap: 'Carte du Monde Interactive',
      itemNature: 'Découvre la Nature',
      itemCursive: 'J\'écris en cursive',
      itemTales: 'Contes Magiques',
      itemEmotions: 'Émotions Magiques',
      itemDailyMissions: 'Missions du Jour',
      itemDailyQuiz: 'Quiz du Jour',
      itemBreath: 'Respire & Repose-toi',
      itemSelfExpression: 'Expression de Soi / Mon Journal',
      colorMixQuestion: 'Quelle couleur apparaît quand on mélange {{a}} + {{b}} ?'
    },
    en: {
      languageLabel: 'Language',
      languageSelectAria: 'Choose language',
      confirmLogout: 'Do you really want to log out?',
      navHome: 'Home',
      navShop: 'Shop',
      navAchievements: 'Achievements',
      navLibrary: 'Library',
      navBack: 'Back',
      navLogout: 'Exit',
      audioOn: 'Sound on',
      audioOff: 'Sound off',
      notifications: 'Notifications',
      levelLabel: 'Level',
      fallbackName: 'Magic Friend',
      loginBadge: '✨ Choose your avatar ✨',
      loginTitle: 'Welcome to your magical adventure',
      loginSteps: 'Pick an avatar, choose your favorite color, and write your name.',
      loginPlayButton: 'Play',
      loginParentAccess: 'Parent access',
      loginParentHold: 'Hold 2 seconds',
      calmModeLabel: 'Calm Mode',
      calmModeDescription: 'Fewer animations and sounds.',
      calmModeOn: 'Calm on',
      calmModeOff: 'Calm off',
      selectedAvatarLabel: 'Chosen avatar',
      selectedAvatarPlaceholder: 'Choose your avatar',
      selectedNameLabel: 'Your name',
      selectedNamePlaceholder: 'Write your name',
      avatarSectionTitle: 'Delightful avatars',
      avatarListLabel: 'Choose your favorite avatar',
      namePlaceholder: 'Write your name here...',
      nameAria: 'Write your name',
      colorSectionTitle: 'Choose your favorite color',
      colorListLabel: 'Choose your favorite color',
      avatarUnicorn: 'Unicorn',
      avatarFox: 'Fox',
      avatarPanda: 'Panda',
      avatarOwl: 'Owl',
      avatarStrawberry: 'Strawberry',
      avatarApple: 'Apple',
      avatarBanana: 'Banana',
      avatarPineapple: 'Pineapple',
      colorRoseLabel: 'Pastel pink',
      colorApricotLabel: 'Soft apricot',
      colorLemonLabel: 'Light lemon',
      colorMintLabel: 'Fresh mint',
      colorOceanLabel: 'Clear ocean',
      colorSkyLabel: 'Calm sky',
      colorLavenderLabel: 'Lavender',
      colorRaspberryLabel: 'Soft raspberry',
      colorWhiteLabel: 'Magic white',
      colorRoseTooltip: '🌸 Pastel pink',
      colorApricotTooltip: '🍑 Soft apricot',
      colorLemonTooltip: '🍋 Light lemon',
      colorMintTooltip: '🌿 Fresh mint',
      colorOceanTooltip: '🌊 Clear ocean',
      colorSkyTooltip: '☁️ Calm sky',
      colorLavenderTooltip: '💜 Lavender',
      colorRaspberryTooltip: '🍓 Soft raspberry',
      colorWhiteTooltip: '✨ Magic white',
      ownedAvatarUse: 'Use',
      ownedBackgroundSet: 'Set',
      avatarAlt: 'Avatar',
      backgroundAlt: 'Background',
      loginButton: 'Enter Lena\'s world',
      loginError: 'Write your name and choose an avatar ✨',
      gameBack: 'Back',
      gameWorld: 'Magic World',
      gameReady: 'Ready to play',
      gameHint: 'Hint',
      gameStart: 'Start',
      gameValidate: 'Check',
      gameNext: 'Next',
      gameCalm: 'Calm',
      gameAnswerPlaceholder: 'Your answer',
      menuPrompt: 'Pick a subject to start.',
      menuChooseLevel: 'Choose a level for {{topic}}',
      menuBackToTopics: 'Back to topics',
      menuBackToMenu: 'Back to main menu',
      menuBackToLevels: 'Back to levels',
      menuBackToStories: 'Back to stories',
      menuBackToMemoryLevels: 'Back to memory levels',
      menuNoQuestions: 'No questions are available for this level yet.',
      menuReviewDone: 'Review done. Great job!',
      menuNoLevels: 'No levels are available yet.',
      reviewFinish: 'Finish review',
      sortingDragHint: 'Drag them into the correct basket.',
      comingSoonTitle: 'Coming soon',
      comingSoonMessage: 'This magical game will be available soon!',
      storyLibraryTitle: 'Magic Tales Library',
      storyNoResults: 'No stories match your search.',
      storyPrevCollection: 'Previous collection',
      storyNextCollection: 'Next collection',
      storyReadToMe: 'Read the story to me',
      storyReadMyself: 'I read by myself',
      storyListenAria: 'Read the story aloud',
      shopBackToMenu: 'Back to menu',
      starsLabel: 'Stars',
      coinsLabel: 'Coins',
      shopFilterAll: 'All',
      filterAll: 'All',
      shopFilterStickers: 'Stickers',
      shopFilterAvatars: 'Avatars',
      shopFilterBackground: 'Backgrounds',
      shopFilterSound: 'Sounds',
      shopFilterOwned: 'My treasures',
      shopHeroTitle: '✨ Magic Shop ✨',
      shopHeroSubtitle: 'Collect sparkling treasures and customize your adventure!',
      shopRareTitle: '🌟 Rare Market 🌟',
      shopMainTitle: '🛍️ Main Shop 🛍️',
      shopMainSubtitle: 'Browse all magical accessories available today.',
      shopTreasuresTitle: '🎁 My Treasures 🎁',
      shopTreasuresSubtitle: 'Find all the items you already own here.',
      shopLoadErrorTitle: 'Shop loading error!',
      shopLoadErrorBody: 'Please check the console for errors and refresh the page.',
      baseTenBuildTitle: 'Build the Number',
      baseTenBuildGoal: 'Target number',
      baseTenBuildFree: 'Free mode',
      baseTenBuildBreak: 'Break a ten',
      baseTenBuildGroup: 'Group 10 ones',
      baseTenBuildHint: 'Drag the blocks to build the number.',
      baseTenBuildFeedback: 'Nice! There are many ways!',
      baseTenBuildEncourage: 'Great try! Let\'s adjust a little more.',
      baseTenBlockTen: 'Ten block',
      baseTenBlockOne: 'One block',
      baseTenBankLabel: 'Block bank',
      baseTenBuildZone: 'Build zone',
      baseTenSubtractTitle: 'Subtract by Transforming',
      baseTenSubtractGoal: 'We transform to take away',
      baseTenSubtractStepTransform: 'Let\'s break a ten.',
      baseTenSubtractStepEasier: 'Now it is easier to take away.',
      baseTenSubtractStepRemove: 'Remove the needed blocks.',
      baseTenSubtractFeedback: 'Well done! You transformed and removed.',
      baseTenSubtractEncourage: 'Easy does it, we\'ll get there.',
      baseTenSubtractTransformBtn: 'Transform one ten',
      baseTenSubtractRemoveBtn: 'Remove now',
      baseTenSubtractNextBtn: 'Next',
      calmToggleAria: 'Toggle calm mode',
      parentResetLabel: 'Reset data',
      parentResetConfirm: 'Are you a parent? Type \"OK\" to confirm.',
      parentResetSuccess: 'Data has been reset.',
      parentResetCancel: 'Reset canceled.',
      parentPanelTitle: 'Parent space',
      parentPanelClose: 'Close',
      shopTitle: 'Reward Shop',
      shopClose: 'Close shop',
      shopSubtitle: 'Trade your coins for magical gifts ✨',
      shopAvailable: 'Available items',
      shopInventory: 'My treasures',
      sectionMathTitle: 'Math',
      sectionNewGamesTitle: 'New Games',
      sectionLogicTitle: 'Logic & Reasoning',
      sectionWordsTitle: 'Words & Reading',
      sectionCreativeTitle: 'Creative & World',
      sectionEmotionsTitle: 'Heart & Emotions',
      itemAdditions: 'Additions',
      itemSubtractions: 'Subtractions',
      itemMultiplications: 'Multiplications',
      itemDivisions: 'Divisions',
      itemMathSprint: 'Math Sprint',
      itemAbacus: 'Magic Abacus',
      itemNumberHouses: 'Number Houses',
      itemTime: 'Time & Clocks',
      itemMeasures: 'Magic Measures',
      itemFractions: 'Fantastic Fractions',
      itemLabyrinth: 'Logic Labyrinth',
      itemSequences: 'Sequence Game',
      itemSorting: 'Sorting & Grouping',
      itemMemory: 'Magic Memory',
      itemSudoku: 'Junior Sudoku',
      itemSymmetry: 'Magic Symmetry',
      itemComparisonCards: 'Comparison Cards',
      itemPathNetworks: 'Path Networks',
      itemLogicgrams: 'Logicgrams (If... Then...)',
      itemRiddles: 'Riddle Game',
      itemRepartis: 'Share & Multiply',
      itemReading: 'Magic Reading',
      itemBigAdventure: 'The Great Word Adventure',
      itemToolWords: 'Tool Words',
      itemVowels: 'Vowel Game',
      itemWitches: 'The Witches - Magic Memory Game',
      itemDictation: 'Magic Dictation',
      itemColors: 'Colors / Art Workshop',
      itemPuzzle: 'Magic Puzzle',
      itemWorldMap: 'Interactive World Map',
      itemNature: 'Discover Nature',
      itemCursive: 'I write in cursive',
      itemTales: 'Magic Tales',
      itemEmotions: 'Magic Emotions',
      itemDailyMissions: 'Missions of the Day',
      itemDailyQuiz: 'Quiz of the Day',
      itemBreath: 'Breathe & Rest',
      itemSelfExpression: 'Self Expression / My Journal',
      colorMixQuestion: 'Which color appears when we mix {{a}} + {{b}}?'
    },
    es: {
      languageLabel: 'Idioma',
      languageSelectAria: 'Elegir idioma',
      confirmLogout: '¿Quieres salir?',
      navHome: 'Inicio',
      navShop: 'Tienda',
      navAchievements: 'Logros',
      navLibrary: 'Biblioteca',
      navBack: 'Atrás',
      navLogout: 'Salir',
      audioOn: 'Sonido activado',
      audioOff: 'Sonido apagado',
      notifications: 'Notificaciones',
      levelLabel: 'Nivel',
      fallbackName: 'Amigo Mágico',
      loginBadge: '✨ Elige tu avatar ✨',
      loginTitle: 'Bienvenido a tu aventura mágica',
      loginSteps: 'Elige un avatar, tu color favorito y escribe tu nombre.',
      loginPlayButton: 'Jugar',
      loginParentAccess: 'Acceso padres',
      loginParentHold: 'Mantén 2 segundos',
      calmModeLabel: 'Modo Calma',
      calmModeDescription: 'Menos animaciones y sonidos.',
      calmModeOn: 'Calma activada',
      calmModeOff: 'Calma desactivada',
      selectedAvatarLabel: 'Avatar elegido',
      selectedAvatarPlaceholder: 'Elige tu avatar',
      selectedNameLabel: 'Tu nombre',
      selectedNamePlaceholder: 'Escribe tu nombre',
      avatarSectionTitle: 'Avatares deliciosos',
      avatarListLabel: 'Elige tu avatar favorito',
      namePlaceholder: 'Escribe tu nombre aquí...',
      nameAria: 'Escribe tu nombre',
      colorSectionTitle: 'Elige tu color favorito',
      colorListLabel: 'Elige tu color favorito',
      avatarUnicorn: 'Unicornio',
      avatarFox: 'Zorro',
      avatarPanda: 'Panda',
      avatarOwl: 'Búho',
      avatarStrawberry: 'Fresa',
      avatarApple: 'Manzana',
      avatarBanana: 'Banana',
      avatarPineapple: 'Piña',
      colorRoseLabel: 'Rosa pastel',
      colorApricotLabel: 'Albaricoque suave',
      colorLemonLabel: 'Limón claro',
      colorMintLabel: 'Menta fresca',
      colorOceanLabel: 'Océano claro',
      colorSkyLabel: 'Cielo calmado',
      colorLavenderLabel: 'Lavanda',
      colorRaspberryLabel: 'Frambuesa suave',
      colorWhiteLabel: 'Blanco mágico',
      colorRoseTooltip: '🌸 Rosa pastel',
      colorApricotTooltip: '🍑 Albaricoque suave',
      colorLemonTooltip: '🍋 Limón claro',
      colorMintTooltip: '🌿 Menta fresca',
      colorOceanTooltip: '🌊 Océano claro',
      colorSkyTooltip: '☁️ Cielo calmado',
      colorLavenderTooltip: '💜 Lavanda',
      colorRaspberryTooltip: '🍓 Frambuesa suave',
      colorWhiteTooltip: '✨ Blanco mágico',
      ownedAvatarUse: 'Usar',
      ownedBackgroundSet: 'Aplicar',
      avatarAlt: 'Avatar',
      backgroundAlt: 'Fondo',
      loginButton: 'Entrar al mundo de Léna',
      loginError: 'Escribe tu nombre y elige un avatar ✨',
      gameBack: 'Atrás',
      gameWorld: 'Mundo Mágico',
      gameReady: 'Listo para jugar',
      gameHint: 'Pista',
      gameStart: 'Empezar',
      gameValidate: 'Validar',
      gameNext: 'Siguiente',
      gameCalm: 'Calma',
      gameAnswerPlaceholder: 'Tu respuesta',
      menuPrompt: 'Elige un tema para empezar.',
      menuChooseLevel: 'Elige un nivel para {{topic}}',
      menuBackToTopics: 'Volver a temas',
      menuBackToMenu: 'Volver al menú principal',
      menuBackToLevels: 'Volver a niveles',
      menuBackToStories: 'Volver a cuentos',
      menuBackToMemoryLevels: 'Volver a niveles de memoria',
      menuNoQuestions: 'No hay preguntas disponibles para este nivel.',
      menuReviewDone: 'Repaso terminado. ¡Bien hecho!',
      comingSoonTitle: 'Pronto',
      comingSoonMessage: '¡Este juego mágico estará disponible pronto!',
      shopBackToMenu: 'Volver al menú',
      starsLabel: 'Estrellas',
      coinsLabel: 'Monedas',
      shopFilterAll: 'Todo',
      filterAll: 'Todos',
      shopFilterStickers: 'Pegatinas',
      shopFilterAvatars: 'Avatares',
      shopFilterBackground: 'Fondos',
      shopFilterSound: 'Sonidos',
      shopFilterOwned: 'Mis tesoros',
      shopHeroTitle: '✨ Tienda Mágica ✨',
      shopHeroSubtitle: '¡Colecciona tesoros brillantes y personaliza tu aventura!',
      shopRareTitle: '🌟 Mercado Raro 🌟',
      shopMainTitle: '🛍️ Tienda Principal 🛍️',
      shopMainSubtitle: 'Explora todos los accesorios mágicos disponibles hoy.',
      shopTreasuresTitle: '🎁 Mis Tesoros 🎁',
      shopTreasuresSubtitle: 'Encuentra aquí todo lo que ya tienes.',
      shopLoadErrorTitle: '¡Error al cargar la tienda!',
      shopLoadErrorBody: 'Revisa la consola y actualiza la página.',
      baseTenBuildTitle: 'Construye el Número',
      baseTenBuildGoal: 'Número objetivo',
      baseTenBuildFree: 'Modo libre',
      baseTenBuildBreak: 'Romper una decena',
      baseTenBuildGroup: 'Agrupar 10 unidades',
      baseTenBuildHint: 'Arrastra los bloques para construir el número.',
      baseTenBuildFeedback: '¡Muy bien! ¡Hay muchas formas!',
      baseTenBuildEncourage: '¡Buen intento! Ajustemos un poco más.',
      baseTenBlockTen: 'Bloque de diez',
      baseTenBlockOne: 'Bloque de una unidad',
      baseTenBankLabel: 'Banco de bloques',
      baseTenBuildZone: 'Zona de construcción',
      baseTenSubtractTitle: 'Restar es Transformar',
      baseTenSubtractGoal: 'Transformamos para quitar',
      baseTenSubtractStepTransform: 'Vamos a descomponer una decena.',
      baseTenSubtractStepEasier: 'Ahora es más fácil quitar.',
      baseTenSubtractStepRemove: 'Quita los bloques necesarios.',
      baseTenSubtractFeedback: '¡Bien hecho! Transformaste y quitaste.',
      baseTenSubtractEncourage: 'Despacio, lo logramos juntos.',
      baseTenSubtractTransformBtn: 'Transformar una decena',
      baseTenSubtractRemoveBtn: 'Quitar ahora',
      baseTenSubtractNextBtn: 'Siguiente',
      calmToggleAria: 'Activar o desactivar modo calma',
      parentResetLabel: 'Reiniciar datos',
      parentResetConfirm: '¿Eres un padre? Escribe "OK" para confirmar.',
      parentResetSuccess: 'Los datos fueron reiniciados.',
      parentResetCancel: 'Reinicio cancelado.',
      parentPanelTitle: 'Espacio para padres',
      parentPanelClose: 'Cerrar',
      shopTitle: 'Tienda de recompensas',
      shopClose: 'Cerrar tienda',
      shopSubtitle: 'Cambia tus monedas por regalos mágicos ✨',
      shopAvailable: 'Artículos disponibles',
      shopInventory: 'Mis tesoros',
      sectionMathTitle: 'Matemáticas',
      sectionNewGamesTitle: 'Nuevos juegos',
      sectionLogicTitle: 'Lógica y razonamiento',
      sectionWordsTitle: 'Palabras y lectura',
      sectionCreativeTitle: 'Creativo y mundo',
      sectionEmotionsTitle: 'Corazón y emociones',
      itemAdditions: 'Sumas',
      itemSubtractions: 'Restas',
      itemMultiplications: 'Multiplicaciones',
      itemDivisions: 'Divisiones',
      itemMathSprint: 'Math Sprint',
      itemAbacus: 'Ábaco mágico',
      itemNumberHouses: 'Casas de números',
      itemTime: 'Tiempo y relojes',
      itemMeasures: 'Medidas mágicas',
      itemFractions: 'Fracciones fantásticas',
      itemLabyrinth: 'Laberinto lógico',
      itemSequences: 'Juego de secuencias',
      itemSorting: 'Ordenar y clasificar',
      itemMemory: 'Memoria mágica',
      itemSudoku: 'Sudoku junior',
      itemSymmetry: 'Simetría mágica',
      itemComparisonCards: 'Cartas comparativas',
      itemPathNetworks: 'Redes de caminos',
      itemLogicgrams: 'Logigramas (Si... Entonces...)',
      itemRiddles: 'Juego de acertijos',
      itemRepartis: 'Repartir y multiplicar',
      itemReading: 'Lectura mágica',
      itemBigAdventure: 'La gran aventura de las palabras',
      itemToolWords: 'Palabras herramienta',
      itemVowels: 'Juego de vocales',
      itemWitches: 'Las brujas - juego de memoria mágico',
      itemDictation: 'Dictado mágico',
      itemColors: 'Colores / Taller de arte',
      itemPuzzle: 'Rompecabezas mágico',
      itemWorldMap: 'Mapa del mundo interactivo',
      itemNature: 'Descubre la naturaleza',
      itemCursive: 'Escribo en cursiva',
      itemTales: 'Cuentos mágicos',
      itemEmotions: 'Emociones mágicas',
      itemDailyMissions: 'Misiones del día',
      itemDailyQuiz: 'Quiz del día',
      itemBreath: 'Respira y descansa',
      itemSelfExpression: 'Autoexpresión / Mi diario',
      colorMixQuestion: '¿Qué color aparece cuando mezclamos {{a}} + {{b}}?',
      storyLibraryTitle: 'Biblioteca de cuentos mágicos',
      storyNoResults: 'Ningún cuento coincide con tu búsqueda.',
      storyPrevCollection: 'Colección anterior',
      storyNextCollection: 'Siguiente colección',
      storyReadToMe: 'Léeme el cuento',
      storyReadMyself: 'Yo leo sola',
      storyListenAria: 'Leer el cuento en voz alta',
      menuNoLevels: 'No hay niveles disponibles por ahora.',
      reviewFinish: 'Terminar el repaso',
      sortingDragHint: 'Arrástralos y suéltalos en la cesta correcta.'
    },
    nl: {
      languageLabel: 'Taal',
      languageSelectAria: 'Taal kiezen',
      confirmLogout: 'Wil je echt uitloggen?',
      navHome: 'Start',
      navShop: 'Winkel',
      navAchievements: 'Prestaties',
      navLibrary: 'Bibliotheek',
      navBack: 'Terug',
      navLogout: 'Uitloggen',
      audioOn: 'Geluid aan',
      audioOff: 'Geluid uit',
      notifications: 'Meldingen',
      levelLabel: 'Niveau',
      fallbackName: 'Magische vriend',
      loginBadge: '✨ Kies je avatar ✨',
      loginTitle: 'Welkom in je magische avontuur',
      loginSteps: 'Kies een avatar, je favoriete kleur en schrijf je naam.',
      loginPlayButton: 'Spelen',
      loginParentAccess: 'Ouder-toegang',
      loginParentHold: '2 seconden vasthouden',
      calmModeLabel: 'Rustige modus',
      calmModeDescription: 'Minder animaties en geluid.',
      calmModeOn: 'Rust aan',
      calmModeOff: 'Rust uit',
      selectedAvatarLabel: 'Gekozen avatar',
      selectedAvatarPlaceholder: 'Kies je avatar',
      selectedNameLabel: 'Je naam',
      selectedNamePlaceholder: 'Schrijf je naam',
      avatarSectionTitle: 'Heerlijke avatars',
      avatarListLabel: 'Kies je favoriete avatar',
      namePlaceholder: 'Schrijf je naam hier...',
      nameAria: 'Schrijf je naam',
      colorSectionTitle: 'Kies je favoriete kleur',
      colorListLabel: 'Kies je favoriete kleur',
      avatarUnicorn: 'Eenhoorn',
      avatarFox: 'Vos',
      avatarPanda: 'Panda',
      avatarOwl: 'Uil',
      avatarStrawberry: 'Aardbei',
      avatarApple: 'Appel',
      avatarBanana: 'Banaan',
      avatarPineapple: 'Ananas',
      colorRoseLabel: 'Pastelroze',
      colorApricotLabel: 'Zachte abrikoos',
      colorLemonLabel: 'Lichte citroen',
      colorMintLabel: 'Frisse munt',
      colorOceanLabel: 'Heldere oceaan',
      colorSkyLabel: 'Rustige lucht',
      colorLavenderLabel: 'Lavendel',
      colorRaspberryLabel: 'Lichte framboos',
      colorWhiteLabel: 'Magisch wit',
      colorRoseTooltip: '🌸 Pastelroze',
      colorApricotTooltip: '🍑 Zachte abrikoos',
      colorLemonTooltip: '🍋 Lichte citroen',
      colorMintTooltip: '🌿 Frisse munt',
      colorOceanTooltip: '🌊 Heldere oceaan',
      colorSkyTooltip: '☁️ Rustige lucht',
      colorLavenderTooltip: '💜 Lavendel',
      colorRaspberryTooltip: '🍓 Lichte framboos',
      colorWhiteTooltip: '✨ Magisch wit',
      ownedAvatarUse: 'Gebruiken',
      ownedBackgroundSet: 'Instellen',
      avatarAlt: 'Avatar',
      backgroundAlt: 'Achtergrond',
      loginButton: 'Ga naar de wereld van Lena',
      loginError: 'Schrijf je naam en kies een avatar ✨',
      gameBack: 'Terug',
      gameWorld: 'Magische Wereld',
      gameReady: 'Klaar om te spelen',
      gameHint: 'Hint',
      gameStart: 'Start',
      gameValidate: 'Bevestigen',
      gameNext: 'Volgende',
      gameCalm: 'Rust',
      gameAnswerPlaceholder: 'Jouw antwoord',
      menuPrompt: 'Kies een onderwerp om te starten.',
      menuChooseLevel: 'Kies een niveau voor {{topic}}',
      menuBackToTopics: 'Terug naar onderwerpen',
      menuBackToMenu: 'Terug naar hoofdmenu',
      menuBackToLevels: 'Terug naar niveaus',
      menuBackToStories: 'Terug naar verhalen',
      menuBackToMemoryLevels: 'Terug naar geheugenniveaus',
      menuNoQuestions: 'Nog geen vragen beschikbaar voor dit niveau.',
      menuReviewDone: 'Herhaling klaar. Goed gedaan!',
      menuNoLevels: 'Nog geen niveaus beschikbaar.',
      reviewFinish: 'Herhaling beëindigen',
      sortingDragHint: 'Sleep ze naar het juiste mandje.',
      comingSoonTitle: 'Binnenkort',
      comingSoonMessage: 'Dit magische spel is binnenkort beschikbaar!',
      storyLibraryTitle: 'Bibliotheek van magische verhalen',
      storyNoResults: 'Geen verhalen gevonden voor je zoekopdracht.',
      storyPrevCollection: 'Vorige collectie',
      storyNextCollection: 'Volgende collectie',
      storyReadToMe: 'Lees het verhaal voor',
      storyReadMyself: 'Ik lees zelf',
      storyListenAria: 'Lees het verhaal hardop',
      shopBackToMenu: 'Terug naar menu',
      starsLabel: 'Sterren',
      coinsLabel: 'Munten',
      shopFilterAll: 'Alles',
      filterAll: 'Alles',
      shopFilterStickers: 'Stickers',
      shopFilterAvatars: 'Avatars',
      shopFilterBackground: 'Achtergronden',
      shopFilterSound: 'Geluiden',
      shopFilterOwned: 'Mijn schatten',
      shopHeroTitle: '✨ Magische Winkel ✨',
      shopHeroSubtitle: 'Verzamel sprankelende schatten en personaliseer je avontuur!',
      shopRareTitle: '🌟 Zeldzame Markt 🌟',
      shopMainTitle: '🛍️ Hoofdwinkel 🛍️',
      shopMainSubtitle: 'Bekijk alle magische accessoires van vandaag.',
      shopTreasuresTitle: '🎁 Mijn Schatten 🎁',
      shopTreasuresSubtitle: 'Vind hier alle spullen die je al hebt.',
      shopLoadErrorTitle: 'Winkel laden mislukt!',
      shopLoadErrorBody: 'Controleer de console en vernieuw de pagina.',
      baseTenBuildTitle: 'Bouw het Getal',
      baseTenBuildGoal: 'Doelgetal',
      baseTenBuildFree: 'Vrije modus',
      baseTenBuildBreak: 'Breek een tiental',
      baseTenBuildGroup: 'Groepeer 10 enen',
      baseTenBuildHint: 'Sleep de blokken om het getal te bouwen.',
      baseTenBuildFeedback: 'Goed zo! Er zijn meerdere manieren!',
      baseTenBuildEncourage: 'Mooie poging! We passen nog een beetje aan.',
      baseTenBlockTen: 'Tienenblok',
      baseTenBlockOne: 'Eenheidsblok',
      baseTenBankLabel: 'Blokkenbank',
      baseTenBuildZone: 'Bouwzone',
      baseTenSubtractTitle: 'Aftrekken is Transformeren',
      baseTenSubtractGoal: 'We transformeren om weg te nemen',
      baseTenSubtractStepTransform: 'We breken een tiental.',
      baseTenSubtractStepEasier: 'Nu is het makkelijker om weg te nemen.',
      baseTenSubtractStepRemove: 'Haal de blokken weg.',
      baseTenSubtractFeedback: 'Goed gedaan! Je hebt getransformeerd en weggenomen.',
      baseTenSubtractEncourage: 'Rustig aan, samen lukt het.',
      baseTenSubtractTransformBtn: 'Transformeer één tiental',
      baseTenSubtractRemoveBtn: 'Nu weghalen',
      baseTenSubtractNextBtn: 'Volgende',
      calmToggleAria: 'Schakel rustige modus',
      parentResetLabel: 'Gegevens resetten',
      parentResetConfirm: 'Ben je een ouder? Typ \"OK\" om te bevestigen.',
      parentResetSuccess: 'Gegevens zijn gereset.',
      parentResetCancel: 'Reset geannuleerd.',
      parentPanelTitle: 'Ouder-ruimte',
      parentPanelClose: 'Sluiten',
      shopTitle: 'Beloningswinkel',
      shopClose: 'Winkel sluiten',
      shopSubtitle: 'Ruil je munten voor magische cadeaus ✨',
      shopAvailable: 'Beschikbare items',
      shopInventory: 'Mijn schatten',
      sectionMathTitle: 'Wiskunde',
      sectionNewGamesTitle: 'Nieuwe spellen',
      sectionLogicTitle: 'Logica en redeneren',
      sectionWordsTitle: 'Woorden en lezen',
      sectionCreativeTitle: 'Creatief en wereld',
      sectionEmotionsTitle: 'Hart en emoties',
      itemAdditions: 'Optellen',
      itemSubtractions: 'Aftrekken',
      itemMultiplications: 'Vermenigvuldigen',
      itemDivisions: 'Delen',
      itemMathSprint: 'Maths Sprint',
      itemAbacus: 'Magisch telraam',
      itemNumberHouses: 'Getallenhuizen',
      itemTime: 'Tijd en klokken',
      itemMeasures: 'Magische maten',
      itemFractions: 'Fantastische breuken',
      itemLabyrinth: 'Logisch labyrint',
      itemSequences: 'Volgorde spel',
      itemSorting: 'Sorteren en rangschikken',
      itemMemory: 'Magisch geheugen',
      itemSudoku: 'Sudoku junior',
      itemSymmetry: 'Magische symmetrie',
      itemComparisonCards: 'Vergelijkingskaarten',
      itemPathNetworks: 'Netwerken van paden',
      itemLogicgrams: 'Logigrammen (Als... Dan...)',
      itemRiddles: 'Raadselspel',
      itemRepartis: 'Verdelen en vermenigvuldigen',
      itemReading: 'Magisch lezen',
      itemBigAdventure: 'Het grote woordenavontuur',
      itemToolWords: 'Hulwoorden',
      itemVowels: 'Klinkerspel',
      itemWitches: 'De heksen - magisch geheugenspel',
      itemDictation: 'Magische dictee',
      itemColors: 'Kleuren / Atelier',
      itemPuzzle: 'Magische puzzel',
      itemWorldMap: 'Interactieve wereldkaart',
      itemNature: 'Ontdek de natuur',
      itemCursive: 'Ik schrijf cursief',
      itemTales: 'Magische verhalen',
      itemEmotions: 'Magische emoties',
      itemDailyMissions: 'Missies van de dag',
      itemDailyQuiz: 'Quiz van de dag',
      itemBreath: 'Adem en rust',
      itemSelfExpression: 'Zelfexpressie / Mijn dagboek',
      colorMixQuestion: 'Welke kleur krijg je als we {{a}} + {{b}} mengen?'
    }
  };

  function readStoredLanguage() {
    try {
      if (window.storage?.getLanguage) {
        return window.storage.getLanguage();
      }
    } catch (error) {
      console.warn('[i18n] storage.getLanguage failed', error);
    }
    try {
      return window.localStorage?.getItem(STORAGE_KEY);
    } catch (error) {
      console.warn('[i18n] localStorage read failed', error);
      return null;
    }
  }

  function normalizeLanguage(lang) {
    if (!lang || typeof lang !== 'string') {
      return DEFAULT_LANGUAGE;
    }
    const trimmed = lang.trim().toLowerCase();
    return STRINGS[trimmed] ? trimmed : DEFAULT_LANGUAGE;
  }

  function getLanguage() {
    const stored = readStoredLanguage();
    if (stored) {
      currentLanguage = stored;
    }
    return normalizeLanguage(stored || currentLanguage || DEFAULT_LANGUAGE);
  }

  function getSpeechLang() {
    const lang = getLanguage();
    return LANGUAGE_LOCALES[lang] || LANGUAGE_LOCALES[DEFAULT_LANGUAGE];
  }

  function setLanguage(lang) {
    const normalized = normalizeLanguage(lang);
    currentLanguage = normalized;
    try {
      if (window.storage?.setLanguage) {
        window.storage.setLanguage(normalized);
      } else {
        window.localStorage?.setItem(STORAGE_KEY, normalized);
      }
    } catch (error) {
      console.warn('[i18n] Failed to save language', error);
    }
    applyDocumentLang(normalized);
    updateAll();
    document.dispatchEvent(new CustomEvent('lena:language:change', { detail: { lang: normalized } }));
  }

  function applyParams(text, params) {
    if (!params || typeof params !== 'object') {
      return text;
    }
    return Object.entries(params).reduce((result, [paramKey, value]) => {
      const token = `{{${paramKey}}}`;
      return result.split(token).join(String(value));
    }, text);
  }

  function t(key, params) {
    if (!key) { return ''; }
    const lang = getLanguage();
    const raw = STRINGS[lang]?.[key] || STRINGS[DEFAULT_LANGUAGE]?.[key] || key;
    return applyParams(raw, params);
  }

  function applyDocumentLang(lang = getLanguage()) {
    document.documentElement.setAttribute('lang', lang);
  }

  function applyTo(root = document) {
    if (!root) { return; }
    root.querySelectorAll('[data-i18n]').forEach(node => {
      const key = node.getAttribute('data-i18n');
      if (!key) { return; }
      node.textContent = t(key);
    });
    root.querySelectorAll('[data-i18n-placeholder]').forEach(node => {
      const key = node.getAttribute('data-i18n-placeholder');
      if (!key) { return; }
      node.setAttribute('placeholder', t(key));
    });
    root.querySelectorAll('[data-i18n-aria]').forEach(node => {
      const key = node.getAttribute('data-i18n-aria');
      if (!key) { return; }
      node.setAttribute('aria-label', t(key));
    });
    root.querySelectorAll('[data-i18n-title]').forEach(node => {
      const key = node.getAttribute('data-i18n-title');
      if (!key) { return; }
      node.setAttribute('title', t(key));
    });
    root.querySelectorAll('[data-i18n-tooltip]').forEach(node => {
      const key = node.getAttribute('data-i18n-tooltip');
      if (!key) { return; }
      node.setAttribute('data-tooltip', t(key));
    });
  }

  function bindLanguageSelect(selectEl) {
    if (!selectEl) { return; }
    selectEl.innerHTML = '';
    Object.entries(LANGUAGE_LABELS).forEach(([code, label]) => {
      const option = document.createElement('option');
      option.value = code;
      option.textContent = label;
      selectEl.appendChild(option);
    });
    selectEl.value = getLanguage();
    selectEl.addEventListener('change', event => {
      setLanguage(event.target.value);
    });
  }

  function initLanguageControls(root = document) {
    root.querySelectorAll('[data-language-select]').forEach(selectEl => {
      bindLanguageSelect(selectEl);
    });
  }

  function updateAll() {
    applyDocumentLang();
    applyTo(document);
    initLanguageControls(document);
  }

  function init() {
    updateAll();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.i18n = {
    t,
    getLanguage,
    setLanguage,
    getSpeechLang,
    apply: applyTo,
    bindLanguageSelect
  };
})();
